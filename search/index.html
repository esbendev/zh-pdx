<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese PDX - search tool</title>
    <link rel="stylesheet" href="estilo.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-475SSTM0WC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-475SSTM0WC');
    </script>
</head>

<body>
    <main>
        <!-- search bar (more of a filter bar, no need to click search) -->
        <input type="text" id="search-bar" placeholder="write anything to filter... (english, 中文, dates, or tags)"
            autofocus>
        <div class="results" id="results">
            <!-- search results will be displayed here -->
        </div>
    </main>
    <script>
        // fetch data from JSON file
        async function fetchData() {
            // const response = await fetch('contenido/palabras-y-frases.json');
            const now = new Date();
            const timestamp = now.getTime();
            const response = await fetch(`contenido/palabras-y-frases.json?timestamp=${timestamp}`);
            const data = await response.json();
            return data;
        }

        // add data to  the results div
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            const list = Array.isArray(data) ? data : (data && data.textos) || [];
            list.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'tarjeta-resultado';
                itemDiv.innerHTML = `
                    <span class="dia">${escapeHtml(item.dia || '')}</span>
                    <span class="contenido"><strong>${escapeHtml(item.contenido)}</strong></span>
                    <span class="pinyin" onclick="playTextToSpeech('${escapeHtml(item.contenido)}')">${escapeHtml(item.pinyin + ' ▶️' || '')}</span>
                    <span class="significado">${escapeHtml(item.significado)}</span>
                    <span class="tags">
                        ${item.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join(' ')}
                    </span>
                `;
                resultsDiv.appendChild(itemDiv);
            });
        }

        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));
        }

        async function init() {
            const all = await fetchData();
            const textos = (all && all.textos) || [];
            const searchBar = document.getElementById('search-bar');
            displayResults(textos);
            setupSearchBar(searchBar, textos);

            // Preload voices
            const synth = window.speechSynthesis;
            if ('speechSynthesis' in window) {
                console.log('Initializing SpeechSynthesis...');
                let retryCount = 0; // Initialize retry counter
                const maxRetries = 4; // Set maximum retries

                const loadVoicesWithRetry = () => {
                    const voices = synth.getVoices();
                    if (voices.length > 0) {
                        console.log('Voices loaded:', voices);
                    } else if (retryCount < maxRetries) {
                        retryCount++;
                        console.log(`Voices not loaded yet. Retrying... (${retryCount}/${maxRetries})`);
                        setTimeout(loadVoicesWithRetry, 500); // Retry after 500ms
                    } else {
                        console.warn('Failed to load voices after maximum retries.');
                    }
                };

                if (synth.getVoices().length > 0) {
                    console.log('Voices already loaded:', synth.getVoices());
                } else {
                    console.log('Waiting for voices to load...');
                    synth.onvoiceschanged = () => {
                        console.log('Voices loaded via onvoiceschanged event.');
                    }; // Wait for voices to load
                    loadVoicesWithRetry(); // Start retry mechanism
                }
            } else {
                console.warn('SpeechSynthesis API is not supported in this browser.');
            }
        }

        function setupSearchBar(searchBar, textos) {
            searchBar.addEventListener('input', e => {
                const q = e.target.value.trim().toLowerCase();
                if (!q) {
                    displayResults(textos);
                    return;
                }
                const filtered = filterResults(textos, q);
                displayResults(filtered);
            });
        }

        function filterResults(textos, query) {
            return textos.filter(it =>
                (it.contenido || '').toLowerCase().includes(query) ||
                (it.significado || '').toLowerCase().includes(query) ||
                (it.dia || '').toLowerCase().includes(query) || // Added to search in the 'dia' field
                String(it.id || '').includes(query) ||
                (it.tags || []).some(tag => tag.toLowerCase().includes(query))
            );
        }

        function playTextToSpeech(text) {
            console.log('playTextToSpeech called with text:', text);

            if (!('speechSynthesis' in window)) {
                console.warn('Text-to-speech not supported in this browser.');
                return;
            }

            const synth = window.speechSynthesis;

            // Stop any currently playing speech
            if (synth.speaking) {
                console.log('Stopping currently playing speech...');
                synth.cancel();
            }

            const voices = synth.getVoices();

            if (voices.length === 0) {
                console.warn('No voices available. Ensure voices are loaded during initialization.');
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN'; // Set language to Chinese
            utterance.voice = voices.find(voice => voice.lang === 'zh-CN') || null;

            if (!utterance.voice) {
                console.warn('No Chinese voice found. Using default voice.');
            } else {
                console.log('Using voice:', utterance.voice);
            }

            synth.speak(utterance);
            console.log('Speech synthesis started.');
        }

        (function () {
            init();
        })();
    </script>
</body>

</html>